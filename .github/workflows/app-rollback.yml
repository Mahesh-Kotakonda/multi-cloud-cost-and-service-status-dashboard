name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      deployment_source:
        description: "Choose whether to rollback from latest or a specific deployment JSON"
        required: true
        default: "latest"
        type: choice
        options:
          - latest
          - specific
      deployment_key:
        description: "S3 key of the deployment JSON (required if source is specific)"
        required: false
        type: string
      components:
        description: "Components to rollback: either 'all' or comma separated (frontend,backend,worker)"
        required: true
        default: "all"
        type: string

concurrency:
  group: rollback-${{ github.ref }}
  cancel-in-progress: true

jobs:
  #############################
  # Pre-Rollback Validation
  #############################
  pre-rollback:
    name: Validate Rollback
    runs-on: self-hosted
    outputs:
      can_rollback: ${{ steps.checks.outputs.can_rollback }}
      deployment_key: ${{ steps.deployment_key.outputs.key }}
      components: ${{ github.event.inputs.components }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      S3_BUCKET: multi-cloud-cost-and-service-status-dashboard
      DEPLOYMENT_JSON_PREFIX: deployments/
      INFRA_JSON_PATH: infra/multi-cloud-dashboard-outputs.json
      ALLOWED_ACTOR: Mahesh-Kotakonda

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: User & Branch Validation
        id: checks
        run: |
          ACTOR="${{ github.actor }}"
          BRANCH="${{ github.ref }}"

          if [ "$ACTOR" != "$ALLOWED_ACTOR" ]; then
            echo "❌ Error: Rollback can only be triggered by $ALLOWED_ACTOR"
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$BRANCH" != "refs/heads/main" ]; then
            echo "❌ Error: Rollback can only run on main branch."
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "✅ Rollback validation passed."
          echo "can_rollback=true" >> $GITHUB_OUTPUT

      - name: Validate Components Input
        run: |
          COMPONENTS="${{ github.event.inputs.components }}"

          if [[ "$COMPONENTS" == "all" ]]; then
            echo "✅ Components set to 'all'."
            exit 0
          fi

          if [[ "$COMPONENTS" == *"all"* ]]; then
            echo "❌ Error: 'all' cannot be combined with other components."
            exit 1
          fi

      - name: Determine Deployment JSON Key
        id: deployment_key
        run: |
          SOURCE="${{ github.event.inputs.deployment_source }}"
          DEPLOYMENT_KEY_INPUT="${{ github.event.inputs.deployment_key }}"

          if [ "$SOURCE" = "specific" ]; then
            if [ -z "$DEPLOYMENT_KEY_INPUT" ]; then
              echo "❌ Error: deployment_key must be provided when source is 'specific'"
              exit 1
            fi
            if ! aws s3api head-object --bucket "$S3_BUCKET" --key "$DEPLOYMENT_KEY_INPUT" >/dev/null 2>&1; then
              echo "❌ Error: deployment_key '$DEPLOYMENT_KEY_INPUT' not found in S3"
              exit 1
            fi
            echo "key=$DEPLOYMENT_KEY_INPUT" >> $GITHUB_OUTPUT
          else
            DEPLOYMENT_KEY=$(aws s3api list-objects-v2 \
                              --bucket $S3_BUCKET \
                              --prefix "$DEPLOYMENT_JSON_PREFIX" \
                              --query 'reverse(sort_by(Contents,&LastModified))[0].Key' \
                              --output text)
            if [ -z "$DEPLOYMENT_KEY" ] || [ "$DEPLOYMENT_KEY" = "None" ]; then
              echo "❌ Error: No deployment JSON found in S3"
              exit 1
            fi
            echo "key=$DEPLOYMENT_KEY" >> $GITHUB_OUTPUT
          fi

      - name: Download Deployment & Infra JSON
        run: |
          DEPLOYMENT_KEY="${{ steps.deployment_key.outputs.key }}"
          aws s3 cp "s3://$S3_BUCKET/$DEPLOYMENT_KEY" ./latest-deployment.json
          aws s3 cp "s3://$S3_BUCKET/$INFRA_JSON_PATH" ./infra-outputs.json

      - name: Upload JSONs as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rollback-jsons
          path: |
            latest-deployment.json
            infra-outputs.json

  #############################
  # Frontend Rollback
  #############################
  rollback_frontend:
    needs: pre-rollback
    if: needs.pre-rollback.outputs.can_rollback == 'true'
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
      PEM_PATH: ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
      SSM_PARAM_NAME: myapp_database_credentials
  
    outputs:
      frontend_status: ${{ steps.rollback_frontend_step.outputs.frontend_status }}
      frontend_active_env: ${{ steps.rollback_frontend_step.outputs.frontend_active_env }}
      frontend_inactive_env: ${{ steps.rollback_frontend_step.outputs.frontend_inactive_env }}
      frontend_active_tg: ${{ steps.rollback_frontend_step.outputs.frontend_active_tg }}
      frontend_inactive_tg: ${{ steps.rollback_frontend_step.outputs.frontend_inactive_tg }}
      frontend_current_image: ${{ steps.rollback_frontend_step.outputs.frontend_current_image }}
      frontend_previous_image: ${{ steps.rollback_frontend_step.outputs.frontend_previous_image }}
      frontend_first_deployment: ${{ steps.rollback_frontend_step.outputs.frontend_first_deployment }}
      frontend_instance_ids: ${{ steps.rollback_frontend_step.outputs.frontend_instance_ids }}
  
    steps:
      - uses: actions/checkout@v4
  
      - uses: actions/download-artifact@v4
        with:
          name: rollback-jsons
          path: ./json-files
  
      - name: Rollback Frontend
        id: rollback_frontend_step
        run: |
          python3 ./deploy/rollback_frontend.py \
            --deployment-json ./json-files/latest-deployment.json \
            --infra-json ./json-files/infra-outputs.json \
            --components ${{ needs.pre-rollback.outputs.components }}



  #############################
  # Backend Rollback
  #############################
  rollback_backend:
    needs: rollback_frontend
    if: needs.pre-rollback.outputs.can_rollback == 'true'
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
      PEM_PATH: ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
      SSM_PARAM_NAME: myapp_database_credentials
  
    outputs:
      backend_status: ${{ steps.rollback_backend_step.outputs.backend_status }}
      backend_active_env: ${{ steps.rollback_backend_step.outputs.backend_active_env }}
      backend_inactive_env: ${{ steps.rollback_backend_step.outputs.backend_inactive_env }}
      backend_active_tg: ${{ steps.rollback_backend_step.outputs.backend_active_tg }}
      backend_inactive_tg: ${{ steps.rollback_backend_step.outputs.backend_inactive_tg }}
      backend_current_image: ${{ steps.rollback_backend_step.outputs.backend_current_image }}
      backend_previous_image: ${{ steps.rollback_backend_step.outputs.backend_previous_image }}
      backend_first_deployment: ${{ steps.rollback_backend_step.outputs.backend_first_deployment }}
      backend_deployed_at: ${{ steps.rollback_backend_step.outputs.backend_deployed_at }}
      backend_deployed_by: ${{ steps.rollback_backend_step.outputs.backend_deployed_by }}
      backend_instance_ids: ${{ steps.rollback_backend_step.outputs.backend_instance_ids }}
  
    steps:
      - uses: actions/checkout@v4
  
      - uses: actions/download-artifact@v4
        with:
          name: rollback-jsons
          path: ./json-files
  
      - name: Rollback Backend
        id: rollback_backend_step
        run: |
          python3 ./deploy/rollback_backend.py \
            --deployment-json ./json-files/latest-deployment.json \
            --infra-json ./json-files/infra-outputs.json \
            --components ${{ needs.pre-rollback.outputs.components }}

  #############################
  # Worker Rollback
  #############################
  rollback_worker:
    needs: rollback_backend
    if: needs.pre-rollback.outputs.can_rollback == 'true'
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      PEM_PATH: ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
      SSM_PARAM_NAME: myapp_database_credentials
  
    outputs:
      worker_status: ${{ steps.rollback_worker_step.outputs.worker_status }}
      worker_current_image: ${{ steps.rollback_worker_step.outputs.worker_current_image }}
      worker_previous_image: ${{ steps.rollback_worker_step.outputs.worker_previous_image }}
      worker_first_deployment: ${{ steps.rollback_worker_step.outputs.worker_first_deployment }}
      worker_deployed_at: ${{ steps.rollback_worker_step.outputs.worker_deployed_at }}
      worker_deployed_by: ${{ steps.rollback_worker_step.outputs.worker_deployed_by }}
      worker_instance_ids: ${{ steps.rollback_worker_step.outputs.worker_instance_ids }}
  
    steps:
      - uses: actions/checkout@v4
  
      - uses: actions/download-artifact@v4
        with:
          name: rollback-jsons
          path: ./json-files
  
      - name: Rollback Worker
        id: rollback_worker_step
        run: |
          python3 ./deploy/rollback_worker.py \
            --deployment-json ./json-files/latest-deployment.json \
            --infra-json ./json-files/infra-outputs.json \
            --components ${{ needs.pre-rollback.outputs.components }}

  #############################
  # Metadata Rollback
  #############################
  rollback_metadata:
    needs: [rollback_worker, rollback_backend, rollback_frontend]
    if: needs.pre-rollback.outputs.can_rollback == 'true'
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DEPLOY_METADATA_S3_BUCKET: multi-cloud-cost-and-service-status-dashboard
  
      # Worker outputs
      WORKER_STATUS: ${{ needs.rollback_worker.outputs.worker_status }}
      WORKER_CURRENT_IMAGE: ${{ needs.rollback_worker.outputs.worker_current_image }}
      WORKER_PREVIOUS_IMAGE: ${{ needs.rollback_worker.outputs.worker_previous_image }}
      WORKER_FIRST_DEPLOYMENT: ${{ needs.rollback_worker.outputs.worker_first_deployment }}
      WORKER_DEPLOYED_AT: ${{ needs.rollback_worker.outputs.worker_deployed_at }}
      WORKER_DEPLOYED_BY: ${{ needs.rollback_worker.outputs.worker_deployed_by }}
      WORKER_INSTANCE_IDS: ${{ needs.rollback_worker.outputs.worker_instance_ids }}
  
      # Backend outputs
      BACKEND_STATUS: ${{ needs.rollback_backend.outputs.backend_status }}
      BACKEND_ACTIVE_ENV: ${{ needs.rollback_backend.outputs.backend_active_env }}
      BACKEND_INACTIVE_ENV: ${{ needs.rollback_backend.outputs.backend_inactive_env }}
      BACKEND_ACTIVE_TG: ${{ needs.rollback_backend.outputs.backend_active_tg }}
      BACKEND_INACTIVE_TG: ${{ needs.rollback_backend.outputs.backend_inactive_tg }}
      BACKEND_CURRENT_IMAGE: ${{ needs.rollback_backend.outputs.backend_current_image }}
      BACKEND_PREVIOUS_IMAGE: ${{ needs.rollback_backend.outputs.backend_previous_image }}
      BACKEND_FIRST_DEPLOYMENT: ${{ needs.rollback_backend.outputs.backend_first_deployment }}
      BACKEND_DEPLOYED_AT: ${{ needs.rollback_backend.outputs.backend_deployed_at }}
      BACKEND_DEPLOYED_BY: ${{ needs.rollback_backend.outputs.backend_deployed_by }}
      BACKEND_INSTANCE_IDS: ${{ needs.rollback_backend.outputs.backend_instance_ids }}
  
      # Frontend outputs
      FRONTEND_STATUS: ${{ needs.rollback_frontend.outputs.frontend_status }}
      FRONTEND_ACTIVE_ENV: ${{ needs.rollback_frontend.outputs.frontend_active_env }}
      FRONTEND_INACTIVE_ENV: ${{ needs.rollback_frontend.outputs.frontend_inactive_env }}
      FRONTEND_ACTIVE_TG: ${{ needs.rollback_frontend.outputs.frontend_active_tg }}
      FRONTEND_INACTIVE_TG: ${{ needs.rollback_frontend.outputs.frontend_inactive_tg }}
      FRONTEND_CURRENT_IMAGE: ${{ needs.rollback_frontend.outputs.frontend_current_image }}
      FRONTEND_PREVIOUS_IMAGE: ${{ needs.rollback_frontend.outputs.frontend_previous_image }}
      FRONTEND_FIRST_DEPLOYMENT: ${{ needs.rollback_frontend.outputs.frontend_first_deployment }}
      FRONTEND_INSTANCE_IDS: ${{ needs.rollback_frontend.outputs.frontend_instance_ids }}
  
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: rollback-jsons
          path: ./json-files
  
      - name: Print Rollback Outputs
        run: |
          echo "=== Worker Outputs ==="
          echo "Status: $WORKER_STATUS"
          echo "Current Image: $WORKER_CURRENT_IMAGE"
          echo "Previous Image: $WORKER_PREVIOUS_IMAGE"
          echo "First Deployment: $WORKER_FIRST_DEPLOYMENT"
          echo "Deployed At: $WORKER_DEPLOYED_AT"
          echo "Deployed By: $WORKER_DEPLOYED_BY"
          echo "Instance IDs: $WORKER_INSTANCE_IDS"
          
          echo "=== Backend Outputs ==="
          echo "Status: $BACKEND_STATUS"
          echo "Active Env: $BACKEND_ACTIVE_ENV"
          echo "Inactive Env: $BACKEND_INACTIVE_ENV"
          echo "Active TG: $BACKEND_ACTIVE_TG"
          echo "Inactive TG: $BACKEND_INACTIVE_TG"
          echo "Current Image: $BACKEND_CURRENT_IMAGE"
          echo "Previous Image: $BACKEND_PREVIOUS_IMAGE"
          echo "First Deployment: $BACKEND_FIRST_DEPLOYMENT"
          echo "Deployed At: $BACKEND_DEPLOYED_AT"
          echo "Deployed By: $BACKEND_DEPLOYED_BY"
          echo "Instance IDs: $BACKEND_INSTANCE_IDS"
          
          echo "=== Frontend Outputs ==="
          echo "Status: $FRONTEND_STATUS"
          echo "Active Env: $FRONTEND_ACTIVE_ENV"
          echo "Inactive Env: $FRONTEND_INACTIVE_ENV"
          echo "Active TG: $FRONTEND_ACTIVE_TG"
          echo "Inactive TG: $FRONTEND_INACTIVE_TG"
          echo "Current Image: $FRONTEND_CURRENT_IMAGE"
          echo "Previous Image: $FRONTEND_PREVIOUS_IMAGE"
          echo "First Deployment: $FRONTEND_FIRST_DEPLOYMENT"
          echo "Instance IDs: $FRONTEND_INSTANCE_IDS"
  
      - name: Finalize Rollback Metadata
        run: |
          python3 ./deploy/rollback_metadata.py \
            --deployment-json ./json-files/latest-deployment.json \
            --infra-json ./json-files/infra-outputs.json \
            --components ${{ needs.pre-rollback.outputs.components }}

