name: App Deployment

on:
  repository_dispatch:
    types: [trigger-deployment]
  workflow_dispatch:

concurrency:
  group: app-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ##########################
  # Pre-check deployment
  ##########################
  pre-check:
    runs-on: self-hosted
    outputs:
      can_deploy: ${{ steps.set-output.outputs.can_deploy }}
    steps:
      - name: Check if deployment should run
        id: set-output
        run: |
          CAN_DEPLOY=false
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            CAN_DEPLOY=true
          fi
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.actor }}" = "Mahesh-Kotakonda" ]; then
            CAN_DEPLOY=true
          fi
          echo "can_deploy=$CAN_DEPLOY" >> $GITHUB_OUTPUT


  ##########################
  # Deploy Worker
  ##########################
  deploy_worker:
    needs: pre-check
    if: needs.pre-check.outputs.can_deploy == 'true'
    runs-on: self-hosted
    environment: production
    outputs:
      worker_status: ${{ steps.deploy_worker.outputs.worker_status }}
      worker_current_image: ${{ steps.deploy_worker.outputs.worker_current_image }}
      worker_previous_image: ${{ steps.deploy_worker.outputs.worker_previous_image }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      SSM_PARAM_NAME: myapp_database_credentials
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Fetch DB credentials from SSM
        run: |
          PARAM_VALUE=$(aws ssm get-parameter --name "$SSM_PARAM_NAME" --with-decryption --query "Parameter.Value" --output text)
          DB_USER=$(echo $PARAM_VALUE | jq -r '.username')
          DB_PASS=$(echo $PARAM_VALUE | jq -r '.password')
          echo "DB_USER=$DB_USER" >> $GITHUB_ENV
          echo "DB_PASS=$DB_PASS" >> $GITHUB_ENV
      - name: Print payload for debugging
        run: |
          echo "Backend: ${{ github.event.client_payload.backend }}"
          echo "Worker: ${{ github.event.client_payload.worker }}"
          echo "Frontend: ${{ github.event.client_payload.frontend }}"


      - name: Deploy Worker
        id: deploy_worker
        run: |
          PEM_PATH=~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
          WORKER_IMAGE="${{ github.event.client_payload.worker }}"
      
          echo "Downloading worker output JSON from S3..."
          aws s3 cp "$S3_JSON_PATH" worker-outputs.json
      
          DB_HOST=$(jq -r '.db.endpoint | split(":")[0]' worker-outputs.json)
          DB_NAME=$(jq -r '.db.name' worker-outputs.json)
          INSTANCE_IDS=$(jq -r '.ec2_instance_ids[]' worker-outputs.json)
      
          echo "Database host: $DB_HOST"
          echo "Database name: $DB_NAME"
          echo "Instances to deploy: $INSTANCE_IDS"
      
          for ID in $INSTANCE_IDS; do
            IP=$(aws ec2 describe-instances --instance-ids $ID --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
            echo "------------------------------------------------------------"
            echo "Deploying worker on instance ID: $ID, IP: $IP"
            
            OLD_CONTAINER_PRESENT=$(ssh -o StrictHostKeyChecking=no -i "$PEM_PATH" ec2-user@"$IP" \
              "sudo docker ps -a --filter 'name=worker' --format '{{.Names}}' | grep -w worker || true")
            if [ -z "$OLD_CONTAINER_PRESENT" ]; then
              echo "No existing worker container found on $IP. First deployment."
              PREV_IMAGE="$WORKER_IMAGE"
            else
              PREV_IMAGE=$(ssh -o StrictHostKeyChecking=no -i "$PEM_PATH" ec2-user@"$IP" \
                "sudo docker inspect --format='{{.Config.Image}}' worker || echo '$WORKER_IMAGE'")
              echo "Found existing worker container on $IP. Previous image: $PREV_IMAGE"
            fi
      
            echo "Cleaning any old worker_new container..."
            ssh -o StrictHostKeyChecking=no -i "$PEM_PATH" ec2-user@"$IP" \
              "sudo docker rm -f worker_new >/dev/null 2>&1 || true"
      
            echo "Logging in to Docker Hub and pulling image: $WORKER_IMAGE"
            ssh -o StrictHostKeyChecking=no -i "$PEM_PATH" ec2-user@"$IP" \
              "echo '$DOCKERHUB_TOKEN' | docker login -u '$DOCKERHUB_USERNAME' --password-stdin; \
               docker pull $WORKER_IMAGE"
      
            echo "Starting new worker container..."
            ssh -o StrictHostKeyChecking=no -i "$PEM_PATH" ec2-user@"$IP" \
              "docker run -d --name worker_new \
                -e AWS_ACCESS_KEY_ID='$AWS_ACCESS_KEY_ID' \
                -e AWS_SECRET_ACCESS_KEY='$AWS_SECRET_ACCESS_KEY' \
                -e AWS_REGION='$AWS_REGION' \
                -e DB_HOST='$DB_HOST' \
                -e DB_NAME='$DB_NAME' \
                -e DB_USER='$DB_USER' \
                -e DB_PASS='$DB_PASS' \
                -e POLL_INTERVAL_SECONDS=60000 \
                $WORKER_IMAGE"
      
            echo "Waiting 30 seconds for the container to start..."
            sleep 30
      
            STATUS=$(ssh -o StrictHostKeyChecking=no -i "$PEM_PATH" ec2-user@"$IP" \
              "sudo docker ps --filter 'name=worker_new' --filter 'status=running' | grep worker_new >/dev/null 2>&1; echo \$?")
            
            if [ "$STATUS" -ne 0 ]; then
              echo "Worker rollout FAILED on $IP. Printing last 200 logs:"
              ssh -o StrictHostKeyChecking=no -i "$PEM_PATH" ec2-user@"$IP" \
                "sudo docker logs --tail=200 worker_new || true; sudo docker rm -f worker_new || true"
              echo "Worker rollout failed. Old worker kept on $IP."
              exit 1
            else
              echo "Worker rollout SUCCESS on $IP."
              echo "worker_current_image=$WORKER_IMAGE" >> $GITHUB_OUTPUT
              echo "worker_previous_image=$PREV_IMAGE" >> $GITHUB_OUTPUT
              echo "worker_status=success" >> $GITHUB_OUTPUT
            fi
          done


  ##########################
  # Deploy Backend
  ##########################
  deploy_backend:
    needs: deploy_worker
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
    outputs:
      backend_status: ${{ steps.deploy.outputs.backend_status }}
      backend_active_env: ${{ steps.deploy.outputs.backend_active_env }}
      backend_current_image: ${{ steps.deploy.outputs.backend_current_image }}
      backend_previous_image: ${{ steps.deploy.outputs.backend_previous_image }}
      backend_blue_tg: ${{ steps.deploy.outputs.backend_blue_tg }}
      backend_green_tg: ${{ steps.deploy.outputs.backend_green_tg }}
      backend_deployed_at: ${{ steps.deploy.outputs.backend_deployed_at }}
      backend_deployed_by: ${{ steps.deploy.outputs.backend_deployed_by }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy Backend (Blue-Green)
        id: deploy_backend
        run: |
          PEM_PATH=~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
          aws s3 cp "$S3_JSON_PATH" backend-outputs.json
          ./deploy/deploy-backend.sh \
            --outputs-json backend-outputs.json \
            --pem-path "$PEM_PATH" \
            --db-host "${DB_HOST}" \
            --db-port "${DB_PORT}" \
            --db-name "${DB_NAME}" \
            --db-user "${DB_USER}" \
            --db-pass "${DB_PASS}" \
            --dockerhub-username "${DOCKERHUB_USERNAME}" \
            --dockerhub-token "${DOCKERHUB_TOKEN}" \
            --image-tag "${{ github.event.client_payload.backend }}" \
            --instance-ids "$(jq -r '.ec2_instance_ids | join(",")' backend-outputs.json)" \
            --blue-tg "$(jq -r '.backend_blue_tg_arn' backend-outputs.json)" \
            --green-tg "$(jq -r '.backend_green_tg_arn' backend-outputs.json)" \
            --aws-access-key-id "${AWS_ACCESS_KEY_ID}" \
            --aws-secret-access-key "${AWS_SECRET_ACCESS_KEY}" \
            --aws-region "${AWS_REGION}"


  ##########################
  # Deploy Frontend
  ##########################
  deploy_frontend:
    needs: deploy_backend
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
    outputs:
      frontend_status: ${{ steps.deploy.outputs.frontend_status }}
      frontend_active_env: ${{ steps.deploy.outputs.frontend_active_env }}
      frontend_current_image: ${{ steps.deploy.outputs.frontend_current_image }}
      frontend_previous_image: ${{ steps.deploy.outputs.frontend_previous_image }}
      frontend_blue_tg: ${{ steps.deploy.outputs.frontend_blue_tg }}
      frontend_green_tg: ${{ steps.deploy.outputs.frontend_green_tg }}
      frontend_deployed_at: ${{ steps.deploy.outputs.frontend_deployed_at }}
      frontend_deployed_by: ${{ steps.deploy.outputs.frontend_deployed_by }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy Frontend (Blue-Green)
        id: deploy_frontend
        run: |
          PEM_PATH=~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
          aws s3 cp "$S3_JSON_PATH" frontend-outputs.json
          ./deploy/deploy-frontend.sh \
            --outputs-json frontend-outputs.json \
            --pem-path "$PEM_PATH" \
            --dockerhub-username "${DOCKERHUB_USERNAME}" \
            --dockerhub-token "${DOCKERHUB_TOKEN}" \
            --image-tag "${{ github.event.client_payload.frontend }}" \
            --instance-ids "$(jq -r '.ec2_instance_ids | join(",")' frontend-outputs.json)" \
            --blue-tg "$(jq -r '.frontend_blue_tg_arn' frontend-outputs.json)" \
            --green-tg "$(jq -r '.frontend_green_tg_arn' frontend-outputs.json)" \
            --aws-access-key-id "${AWS_ACCESS_KEY_ID}" \
            --aws-secret-access-key "${AWS_SECRET_ACCESS_KEY}" \
            --aws-region "${AWS_REGION}"


  ##########################
  # Deploy Metadata
  ##########################
  deploy_metadata:
    needs: deploy_frontend
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      DEPLOY_METADATA_S3_BUCKET: multi-cloud-cost-and-service-status-dashboard
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download infra outputs JSON
        run: |
          S3_JSON_PATH="s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json"
          aws s3 cp "$S3_JSON_PATH" infra-outputs.json
          echo "infra_outputs_json=infra-outputs.json" >> $GITHUB_ENV

          INSTANCE_IDS=$(jq -r '.ec2_instance_ids | join(",")' infra-outputs.json)
          echo "instance_ids=$INSTANCE_IDS" >> $GITHUB_ENV

          LISTENER_ARN=$(jq -r '.alb_listener_arn' infra-outputs.json)
          echo "listener_arn=$LISTENER_ARN" >> $GITHUB_ENV
          
      - name: Print job outputs for debugging
        run: |
          echo "Worker Current Image: ${{ needs.deploy_worker.outputs.worker_current_image }}"
          echo "Worker Previous Image: ${{ needs.deploy_worker.outputs.worker_previous_image }}"
          echo "Worker Status: ${{ needs.deploy_worker.outputs.worker_status }}"
          echo "Backend Current Image: ${{ needs.deploy_backend.outputs.backend_current_image }}"
          echo "Backend Previous Image: ${{ needs.deploy_backend.outputs.backend_previous_image }}"
          echo "Backend Blue TG: ${{ needs.deploy_backend.outputs.backend_blue_tg }}"
          echo "Backend Green TG: ${{ needs.deploy_backend.outputs.backend_green_tg }}"
          echo "Backend Active Env: ${{ needs.deploy_backend.outputs.backend_active_env }}"
          echo "Frontend Current Image: ${{ needs.deploy_frontend.outputs.frontend_current_image }}"
          echo "Frontend Previous Image: ${{ needs.deploy_frontend.outputs.frontend_previous_image }}"
          echo "Frontend Blue TG: ${{ needs.deploy_frontend.outputs.frontend_blue_tg }}"
          echo "Frontend Green TG: ${{ needs.deploy_frontend.outputs.frontend_green_tg }}"
          echo "Frontend Active Env: ${{ needs.deploy_frontend.outputs.frontend_active_env }}"
          echo "Instance IDs: ${{ env.instance_ids }}"
          echo "Listener ARN: ${{ env.listener_arn }}"
          echo "Infra Outputs JSON: ${{ env.infra_outputs_json }}"
          echo "DockerHub Username: ${{ env.DOCKERHUB_USERNAME }}"
          echo "AWS Access Key: ${{ env.AWS_ACCESS_KEY_ID }}"
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo "Image Repo: ${{ env.IMAGE_REPO }}"
          echo "S3 Bucket: ${{ env.DEPLOY_METADATA_S3_BUCKET }}"
          echo "GitHub Actor: ${{ github.actor }}"


      - name: Run metadata.py
        run: |
          python3 ./deploy/metadata.py \
            --pem-path ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem \
            --worker-current-image "${{ needs.deploy_worker.outputs.worker_current_image }}" \
            --worker-previous-image "${{ needs.deploy_worker.outputs.worker_previous_image }}" \
            --worker-status "${{ needs.deploy_worker.outputs.worker_status }}" \
            --backend-current-image "${{ needs.deploy_backend.outputs.backend_current_image }}" \
            --backend-previous-image "${{ needs.deploy_backend.outputs.backend_previous_image }}" \
            --frontend-current-image "${{ needs.deploy_frontend.outputs.frontend_current_image }}" \
            --frontend-previous-image "${{ needs.deploy_frontend.outputs.frontend_previous_image }}" \
            --instance-ids "${{ env.instance_ids }}" \
            --backend-blue-tg "${{ needs.deploy_backend.outputs.backend_blue_tg }}" \
            --backend-green-tg "${{ needs.deploy_backend.outputs.backend_green_tg }}" \
            --backend-active-env "${{ needs.deploy_backend.outputs.backend_active_env }}" \
            --frontend-blue-tg "${{ needs.deploy_frontend.outputs.frontend_blue_tg }}" \
            --frontend-green-tg "${{ needs.deploy_frontend.outputs.frontend_green_tg }}" \
            --frontend-active-env "${{ needs.deploy_frontend.outputs.frontend_active_env }}" \
            --infra-outputs-json "${{ env.infra_outputs_json }}" \
            --dockerhub-username "${{ env.DOCKERHUB_USERNAME }}" \
            --dockerhub-token "${{ env.DOCKERHUB_TOKEN }}" \
            --aws-access-key-id "${{ env.AWS_ACCESS_KEY_ID }}" \
            --aws-secret-access-key "${{ env.AWS_SECRET_ACCESS_KEY }}" \
            --aws-region "${{ env.AWS_REGION }}" \
            --image-repo "${{ env.IMAGE_REPO }}" \
            --listener-arn "${{ env.listener_arn }}" \
            --s3-bucket "${{ env.DEPLOY_METADATA_S3_BUCKET }}" \
            --github-actor "${{ github.actor }}"
