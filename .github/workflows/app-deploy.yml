name: App Deployment

on:
  repository_dispatch:
    types: [trigger-deployment]
  workflow_dispatch:
    inputs:
      components:
        description: "Which components to deploy (all, worker, backend, frontend, or comma-separated list)"
        required: false
        default: "all"
      worker_version:
        description: "Version tag for worker (default: latest)"
        required: false
        default: "latest"
      backend_version:
        description: "Version tag for backend (default: latest)"
        required: false
        default: "latest"
      frontend_version:
        description: "Version tag for frontend (default: latest)"
        required: false
        default: "latest"

concurrency:
  group: app-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ##########################
  # Pre-deploy
  ##########################
  pre-deploy:
    runs-on: self-hosted
    outputs:
      can_deploy: ${{ steps.pre.outputs.can_deploy }}
      components: ${{ steps.pre.outputs.components }}
      worker_version: ${{ steps.pre.outputs.worker_version }}
      backend_version: ${{ steps.pre.outputs.backend_version }}
      frontend_version: ${{ steps.pre.outputs.frontend_version }}
      worker_image: ${{ steps.pre.outputs.worker_image }}
      backend_image: ${{ steps.pre.outputs.backend_image }}
      frontend_image: ${{ steps.pre.outputs.frontend_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run pre-deploy script
        id: pre
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          INPUT_COMPONENTS: ${{ github.event.inputs.components || '' }}
          INPUT_WORKER_VERSION: ${{ github.event.inputs.worker_version || '' }}
          INPUT_BACKEND_VERSION: ${{ github.event.inputs.backend_version || '' }}
          INPUT_FRONTEND_VERSION: ${{ github.event.inputs.frontend_version || '' }}
          CLIENT_PAYLOAD_WORKER: ${{ github.event.client_payload.worker || '' }}
          CLIENT_PAYLOAD_BACKEND: ${{ github.event.client_payload.backend || '' }}
          CLIENT_PAYLOAD_FRONTEND: ${{ github.event.client_payload.frontend || '' }}
        run: ./.github/scripts/pre_deploy.sh



  deploy_worker:
    needs: [pre-deploy]
    if: needs.pre-check.outputs.can_deploy == 'true'
    runs-on: self-hosted
    environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
      SSM_PARAM_NAME: myapp_database_credentials
      PEM_PATH: ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
  
    outputs:
      previous_image: ${{ steps.deploy.outputs.previous_image }}
      current_image: ${{ steps.deploy.outputs.current_image }}
      deployed_instance_ids: ${{ steps.deploy.outputs.deployed_instance_ids }}
      deploy_status: ${{ steps.deploy.outputs.deploy_status }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
  
      - name: Run worker deployment script
        id: deploy
        run: ./deploy/deploy_worker.sh "${{ needs.resolve-images.outputs.worker_image }}"





  ##########################
  # Deploy Backend
  ##########################
  deploy_backend:
    needs: [pre-deploy, deploy_worker]
    if: needs.pre-check.outputs.can_deploy == 'true' && (needs.resolve-images.outputs.backend_image != '')
    runs-on: self-hosted
    environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
      SSM_PARAM_NAME: myapp_database_credentials
    outputs:
      backend_status: ${{ steps.deploy_backend.outputs.backend_status }}
      backend_active_env: ${{ steps.deploy_backend.outputs.backend_active_env }}
      backend_current_image: ${{ steps.deploy_backend.outputs.backend_current_image }}
      backend_previous_image: ${{ steps.deploy_backend.outputs.backend_previous_image }}
      backend_blue_tg: ${{ steps.deploy_backend.outputs.backend_blue_tg }}
      backend_green_tg: ${{ steps.deploy_backend.outputs.backend_green_tg }}
      backend_deployed_at: ${{ steps.deploy_backend.outputs.backend_deployed_at }}
      backend_deployed_by: ${{ steps.deploy_backend.outputs.backend_deployed_by }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Fetch DB credentials and instance info
        id: fetch_db
        run: |
          PEM_PATH=~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
  
          echo "Downloading backend JSON from S3..."
          aws s3 cp "$S3_JSON_PATH" backend-outputs.json
  
          # Fetch DB host, port, and name from JSON
          DB_ENDPOINT=$(jq -r '.db.endpoint' backend-outputs.json)
          DB_HOST=$(echo $DB_ENDPOINT | cut -d':' -f1)
          DB_PORT=$(echo $DB_ENDPOINT | cut -d':' -f2)
          DB_NAME=$(jq -r '.db.name' backend-outputs.json)
  
          INSTANCE_IDS=$(jq -r '.ec2_instance_ids | join(",")' backend-outputs.json)
          BLUE_TG=$(jq -r '.backend_blue_tg_arn' backend-outputs.json)
          GREEN_TG=$(jq -r '.backend_green_tg_arn' backend-outputs.json)
  
          # Fetch DB credentials from SSM
          PARAM_VALUE=$(aws ssm get-parameter --name "$SSM_PARAM_NAME" --with-decryption --query "Parameter.Value" --output text)
          DB_USER=$(echo $PARAM_VALUE | jq -r '.username')
          DB_PASS=$(echo $PARAM_VALUE | jq -r '.password')
  
          # Export worker instance IDs if available from worker job
          WORKER_INSTANCE_IDS="${{ needs.deploy_worker.outputs.deployed_instance_ids }}"
  
          # Export backend image resolved from previous job
          BACKEND_IMAGE="${{ needs.resolve-images.outputs.backend_image }}"
  
          # Export to GitHub environment
          echo "DB_HOST=$DB_HOST" >> $GITHUB_ENV
          echo "DB_PORT=$DB_PORT" >> $GITHUB_ENV
          echo "DB_NAME=$DB_NAME" >> $GITHUB_ENV
          echo "DB_USER=$DB_USER" >> $GITHUB_ENV
          echo "DB_PASS=$DB_PASS" >> $GITHUB_ENV
          echo "INSTANCE_IDS=$INSTANCE_IDS" >> $GITHUB_ENV
          echo "BACKEND_BLUE_TG=$BLUE_TG" >> $GITHUB_ENV
          echo "BACKEND_GREEN_TG=$GREEN_TG" >> $GITHUB_ENV
          echo "WORKER_INSTANCE_IDS=$WORKER_INSTANCE_IDS" >> $GITHUB_ENV
          echo "BACKEND_IMAGE=$BACKEND_IMAGE" >> $GITHUB_ENV
  
      - name: Deploy Backend (Blue-Green)
        id: deploy_backend
        run: |
          if [ -z "$BACKEND_IMAGE" ]; then
            echo "No backend image resolved. Skipping backend deployment."
            exit 0
          fi
  
          PEM_PATH=~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
  
          ./deploy/deploy-backend.sh \
            --outputs-json backend-outputs.json \
            --pem-path "$PEM_PATH" \
            --db-host "$DB_HOST" \
            --db-port "$DB_PORT" \
            --db-name "$DB_NAME" \
            --db-user "$DB_USER" \
            --db-pass "$DB_PASS" \
            --dockerhub-username "$DOCKERHUB_USERNAME" \
            --dockerhub-token "$DOCKERHUB_TOKEN" \
            --image-tag "$BACKEND_IMAGE" \
            --instance-ids "$INSTANCE_IDS" \
            --worker-instance-ids "$WORKER_INSTANCE_IDS" \
            --blue-tg "$BACKEND_BLUE_TG" \
            --green-tg "$BACKEND_GREEN_TG" \
            --aws-access-key-id "$AWS_ACCESS_KEY_ID" \
            --aws-secret-access-key "$AWS_SECRET_ACCESS_KEY" \
            --aws-region "$AWS_REGION"




  ##########################
  # Deploy Frontend
  ##########################
  deploy_frontend:
    needs: [pre-deploy, deploy_worker, deploy_backend]
    if: needs.pre-check.outputs.can_deploy == 'true' && (needs.resolve-images.outputs.frontend_image != '')
    runs-on: self-hosted
    environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
      WORKER_INSTANCE_IDS: ${{ needs.deploy_worker.outputs.deployed_instance_ids || '' }}
      BACKEND_INSTANCE_IDS: ${{ needs.deploy_backend.outputs.backend_current_image && needs.deploy_backend.outputs.backend_instance_ids || '' }}
      FRONTEND_IMAGE: ${{ needs.resolve-images.outputs.frontend_image }}
    outputs:
      frontend_status: ${{ steps.deploy_frontend.outputs.frontend_status }}
      frontend_active_env: ${{ steps.deploy_frontend.outputs.frontend_active_env }}
      frontend_current_image: ${{ steps.deploy_frontend.outputs.frontend_current_image }}
      frontend_previous_image: ${{ steps.deploy_frontend.outputs.frontend_previous_image }}
      frontend_blue_tg: ${{ steps.deploy_frontend.outputs.frontend_blue_tg }}
      frontend_green_tg: ${{ steps.deploy_frontend.outputs.frontend_green_tg }}
      frontend_deployed_at: ${{ steps.deploy_frontend.outputs.frontend_deployed_at }}
      frontend_deployed_by: ${{ steps.deploy_frontend.outputs.frontend_deployed_by }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Deploy Frontend (Blue-Green)
        id: deploy_frontend
        run: |
          if [ -z "$FRONTEND_IMAGE" ]; then
            echo "No frontend image resolved. Skipping frontend deployment."
            exit 0
          fi
  
          PEM_PATH=~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
  
          echo "Downloading frontend infra outputs..."
          aws s3 cp "$S3_JSON_PATH" frontend-outputs.json
  
          ./deploy/deploy-frontend.sh \
            --outputs-json frontend-outputs.json \
            --pem-path "$PEM_PATH" \
            --dockerhub-username "$DOCKERHUB_USERNAME" \
            --dockerhub-token "$DOCKERHUB_TOKEN" \
            --image-tag "$FRONTEND_IMAGE" \
            --instance-ids "$(jq -r '.ec2_instance_ids | join(",")' frontend-outputs.json)" \
            --worker-instance-ids "$WORKER_INSTANCE_IDS" \
            --backend-instance-ids "$BACKEND_INSTANCE_IDS" \
            --blue-tg "$(jq -r '.frontend_blue_tg_arn' frontend-outputs.json)" \
            --green-tg "$(jq -r '.frontend_green_tg_arn' frontend-outputs.json)" \
            --aws-access-key-id "$AWS_ACCESS_KEY_ID" \
            --aws-secret-access-key "$AWS_SECRET_ACCESS_KEY" \
            --aws-region "$AWS_REGION"



  ##########################
  # Deploy Metadata
  ##########################
  deploy_metadata:
    needs: [deploy_worker, deploy_backend, deploy_frontend]
    if: needs.pre-check.outputs.can_deploy == 'true'
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      DEPLOY_METADATA_S3_BUCKET: multi-cloud-cost-and-service-status-dashboard
      WORKER_INSTANCE_IDS: ${{ needs.deploy_worker.outputs.deployed_instance_ids || '' }}
      BACKEND_INSTANCE_IDS: ${{ needs.deploy_backend.outputs.backend_instance_ids || '' }}
      FRONTEND_INSTANCE_IDS: ${{ needs.deploy_frontend.outputs.frontend_instance_ids || '' }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Download infra outputs JSON
        run: |
          S3_JSON_PATH="s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json"
          aws s3 cp "$S3_JSON_PATH" infra-outputs.json
          echo "infra_outputs_json=infra-outputs.json" >> $GITHUB_ENV
  
          INSTANCE_IDS=$(jq -r '.ec2_instance_ids | join(",")' infra-outputs.json)
          echo "instance_ids=$INSTANCE_IDS" >> $GITHUB_ENV
  
          LISTENER_ARN=$(jq -r '.alb_listener_arn' infra-outputs.json)
          echo "listener_arn=$LISTENER_ARN" >> $GITHUB_ENV
  
      - name: Print job outputs for debugging
        run: |
          echo "Worker Current Image: ${{ needs.deploy_worker.outputs.worker_current_image }}"
          echo "Worker Previous Image: ${{ needs.deploy_worker.outputs.worker_previous_image }}"
          echo "Worker Status: ${{ needs.deploy_worker.outputs.worker_status }}"
          echo "Worker Instances: ${{ env.WORKER_INSTANCE_IDS }}"
          echo "Backend Current Image: ${{ needs.deploy_backend.outputs.backend_current_image }}"
          echo "Backend Previous Image: ${{ needs.deploy_backend.outputs.backend_previous_image }}"
          echo "Backend Instances: ${{ env.BACKEND_INSTANCE_IDS }}"
          echo "Frontend Current Image: ${{ needs.deploy_frontend.outputs.frontend_current_image }}"
          echo "Frontend Previous Image: ${{ needs.deploy_frontend.outputs.frontend_previous_image }}"
          echo "Frontend Instances: ${{ env.FRONTEND_INSTANCE_IDS }}"
          echo "Instance IDs: ${{ env.instance_ids }}"
          echo "Listener ARN: ${{ env.listener_arn }}"
          echo "Infra Outputs JSON: ${{ env.infra_outputs_json }}"
          echo "DockerHub Username: ${{ env.DOCKERHUB_USERNAME }}"
          echo "AWS Access Key: ${{ env.AWS_ACCESS_KEY_ID }}"
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo "Image Repo: ${{ env.IMAGE_REPO }}"
          echo "S3 Bucket: ${{ env.DEPLOY_METADATA_S3_BUCKET }}"
          echo "GitHub Actor: ${{ github.actor }}"
  
      - name: Run metadata.py
        run: |
          python3 ./deploy/metadata.py \
            --pem-path ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem \
            --worker-current-image "${{ needs.deploy_worker.outputs.worker_current_image }}" \
            --worker-previous-image "${{ needs.deploy_worker.outputs.worker_previous_image }}" \
            --worker-status "${{ needs.deploy_worker.outputs.worker_status }}" \
            --worker-instance-ids "$WORKER_INSTANCE_IDS" \
            --backend-current-image "${{ needs.deploy_backend.outputs.backend_current_image }}" \
            --backend-previous-image "${{ needs.deploy_backend.outputs.backend_previous_image }}" \
            --backend-instance-ids "$BACKEND_INSTANCE_IDS" \
            --frontend-current-image "${{ needs.deploy_frontend.outputs.frontend_current_image }}" \
            --frontend-previous-image "${{ needs.deploy_frontend.outputs.frontend_previous_image }}" \
            --frontend-instance-ids "$FRONTEND_INSTANCE_IDS" \
            --instance-ids "${{ env.instance_ids }}" \
            --backend-blue-tg "${{ needs.deploy_backend.outputs.backend_blue_tg }}" \
            --backend-green-tg "${{ needs.deploy_backend.outputs.backend_green_tg }}" \
            --backend-active-env "${{ needs.deploy_backend.outputs.backend_active_env }}" \
            --frontend-blue-tg "${{ needs.deploy_frontend.outputs.frontend_blue_tg }}" \
            --frontend-green-tg "${{ needs.deploy_frontend.outputs.frontend_green_tg }}" \
            --frontend-active-env "${{ needs.deploy_frontend.outputs.frontend_active_env }}" \
            --infra-outputs-json "${{ env.infra_outputs_json }}" \
            --dockerhub-username "${{ env.DOCKERHUB_USERNAME }}" \
            --dockerhub-token "${{ env.DOCKERHUB_TOKEN }}" \
            --aws-access-key-id "${{ env.AWS_ACCESS_KEY_ID }}" \
            --aws-secret-access-key "${{ env.AWS_SECRET_ACCESS_KEY }}" \
            --aws-region "${{ env.AWS_REGION }}" \
            --image-repo "${{ env.IMAGE_REPO }}" \
            --listener-arn "${{ env.listener_arn }}" \
            --s3-bucket "${{ env.DEPLOY_METADATA_S3_BUCKET }}" \
            --github-actor "${{ github.actor }}"

