name: App Deployment

on:
  repository_dispatch:
    types: [trigger-deployment]
  workflow_dispatch:
    inputs:
      components:
        description: "Which components to deploy (all, worker, backend, frontend, or comma-separated list)"
        required: false
        default: "all"
      worker_version:
        description: "Version tag for worker (default: latest)"
        required: false
        default: "latest"
      backend_version:
        description: "Version tag for backend (default: latest)"
        required: false
        default: "latest"
      frontend_version:
        description: "Version tag for frontend (default: latest)"
        required: false
        default: "latest"

concurrency:
  group: app-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ##########################
  # Pre-deploy
  ##########################
  pre-deploy:
    runs-on: self-hosted
    outputs:
      can_deploy: ${{ steps.pre.outputs.can_deploy }}
      components: ${{ steps.pre.outputs.components }}
      worker_version: ${{ steps.pre.outputs.worker_version }}
      backend_version: ${{ steps.pre.outputs.backend_version }}
      frontend_version: ${{ steps.pre.outputs.frontend_version }}
      worker_image: ${{ steps.pre.outputs.worker_image }}
      backend_image: ${{ steps.pre.outputs.backend_image }}
      frontend_image: ${{ steps.pre.outputs.frontend_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run pre-deploy script
        id: pre
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          INPUT_COMPONENTS: ${{ github.event.inputs.components || '' }}
          INPUT_WORKER_VERSION: ${{ github.event.inputs.worker_version || '' }}
          INPUT_BACKEND_VERSION: ${{ github.event.inputs.backend_version || '' }}
          INPUT_FRONTEND_VERSION: ${{ github.event.inputs.frontend_version || '' }}
          CLIENT_PAYLOAD_WORKER: ${{ github.event.client_payload.worker || '' }}
          CLIENT_PAYLOAD_BACKEND: ${{ github.event.client_payload.backend || '' }}
          CLIENT_PAYLOAD_FRONTEND: ${{ github.event.client_payload.frontend || '' }}
        run: ./deploy/pre_deploy.sh



  deploy_worker:
    needs: [pre-deploy]
    if: needs.pre-deploy.outputs.can_deploy == 'true'
    runs-on: self-hosted
    # environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
      SSM_PARAM_NAME: myapp_database_credentials
      PEM_PATH: ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
  
    outputs:
      worker_previous_image: ${{ steps.deploy.outputs.worker_previous_image }}
      worker_current_image: ${{ steps.deploy.outputs.worker_current_image }}
      worker_deploy_status: ${{ steps.deploy.outputs.worker_deploy_status }}
      worker_deployed_instance_ids: ${{ steps.deploy.outputs.worker_deployed_instance_ids }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
  
      - name: Run worker deployment script
        id: deploy
        run: ./deploy/deploy-worker.sh "${{ needs.pre-deploy.outputs.worker_image }}"

  ##########################
  # Deploy Backend
  ##########################
  deploy_backend:
    needs: [pre-deploy, deploy_worker]
    if: needs.pre-deploy.outputs.can_deploy == 'true'
    runs-on: self-hosted
    # environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
      PEM_PATH: ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
      WORKER_INSTANCE_IDS: ${{ needs.deploy_worker.outputs.worker_deployed_instance_ids }}
      BACKEND_IMAGE: ${{ needs.pre-deploy.outputs.backend_image }}
      SSM_PARAM_NAME: myapp_database_credentials
    outputs:
      backend_status: ${{ steps.deploy_backend.outputs.backend_status }}
      backend_active_env: ${{ steps.deploy_backend.outputs.backend_active_env }}
      backend_inactive_env: ${{ steps.deploy_backend.outputs.backend_inactive_env }}
      backend_active_tg: ${{ steps.deploy_backend.outputs.backend_active_tg }}
      backend_inactive_tg: ${{ steps.deploy_backend.outputs.backend_inactive_tg }}
      backend_current_image: ${{ steps.deploy_backend.outputs.backend_current_image }}
      backend_previous_image: ${{ steps.deploy_backend.outputs.backend_previous_image }}
      backend_deployed_at: ${{ steps.deploy_backend.outputs.backend_deployed_at }}
      backend_deployed_by: ${{ steps.deploy_backend.outputs.backend_deployed_by }}
      backend_first_deployment: ${{ steps.deploy_backend.outputs.backend_first_deployment }} 
      backend_instance_ids: ${{ steps.deploy_backend.outputs.backend_instance_ids }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Download backend infra outputs
        run: aws s3 cp "$S3_JSON_PATH" backend-outputs.json
  
      - name: Deploy Backend (Blue-Green)
        id: deploy_backend
        run: |
          ./deploy/deploy-backend.sh \
            --outputs-json backend-outputs.json



  ##########################
  # Deploy Frontend
  ##########################
  deploy_frontend:
    needs: [pre-deploy, deploy_worker, deploy_backend]
    if: needs.pre-deploy.outputs.can_deploy == 'true'
    runs-on: self-hosted
    # environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      S3_JSON_PATH: s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json
      PEM_PATH: ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
      BACKEND_FIRST_DEPLOYMENT: ${{ needs.deploy_backend.outputs.backend_first_deployment }}
      WORKER_INSTANCE_IDS: ${{ needs.deploy_worker.outputs.worker_deployed_instance_ids }}
      BACKEND_INSTANCE_IDS: ${{ needs.deploy_backend.outputs.backend_instance_ids }}  # Backend instance IDs
      BACKEND_INACTIVE_ENV: ${{ needs.deploy_backend.outputs.backend_inactive_env }}  # Backend inactive env
      FRONTEND_IMAGE: ${{ needs.pre-deploy.outputs.frontend_image }}
      FRONTEND_INSTANCE_IDS: ${{ needs.deploy_backend.outputs.backend_instance_ids }} # or your frontend instance list
    outputs:
      frontend_status: ${{ steps.deploy_frontend.outputs.frontend_status }}
      frontend_active_env: ${{ steps.deploy_frontend.outputs.frontend_active_env }}
      frontend_inactive_env: ${{ steps.deploy_frontend.outputs.frontend_inactive_env }}
      frontend_active_tg: ${{ steps.deploy_frontend.outputs.frontend_active_tg }}
      frontend_inactive_tg: ${{ steps.deploy_frontend.outputs.frontend_inactive_tg }}
      frontend_current_image: ${{ steps.deploy_frontend.outputs.frontend_current_image }}
      frontend_previous_image: ${{ steps.deploy_frontend.outputs.frontend_previous_image }}
      frontend_deployed_at: ${{ steps.deploy_frontend.outputs.frontend_deployed_at }}
      frontend_deployed_by: ${{ steps.deploy_frontend.outputs.frontend_deployed_by }}
      backend_first_deployment: ${{ needs.deploy_backend.outputs.backend_first_deployment }}
      frontend_instance_ids: ${{ steps.deploy_frontend.outputs.frontend_instance_ids }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Download frontend infra outputs
        run: aws s3 cp "$S3_JSON_PATH" frontend-outputs.json
  
      - name: Deploy Frontend (Blue-Green)
        id: deploy_frontend
        run: |
          ./deploy/deploy-frontend.sh \
            --outputs-json frontend-outputs.json





  deploy_metadata:
    needs: [deploy_worker, deploy_backend, deploy_frontend]
    if: needs.pre-deploy.outputs.can_deploy == 'true'
    runs-on: self-hosted
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REPO: multi-cloud-cost-and-service-status-dashboard-repo
      DEPLOY_METADATA_S3_BUCKET: multi-cloud-cost-and-service-status-dashboard
      PEM_PATH: ~/ssh-keys/multi-cloud-cost-and-service-status-key.pem
  
      # Worker outputs
      WORKER_CURRENT_IMAGE: ${{ needs.deploy_worker.outputs.worker_current_image }}
      WORKER_PREVIOUS_IMAGE: ${{ needs.deploy_worker.outputs.worker_previous_image }}
      WORKER_STATUS: ${{ needs.deploy_worker.outputs.worker_deploy_status }}
      WORKER_INSTANCE_IDS: ${{ needs.deploy_worker.outputs.worker_deployed_instance_ids }}
  
      # Backend outputs
      BACKEND_CURRENT_IMAGE: ${{ needs.deploy_backend.outputs.backend_current_image }}
      BACKEND_PREVIOUS_IMAGE: ${{ needs.deploy_backend.outputs.backend_previous_image }}
      BACKEND_STATUS: ${{ needs.deploy_backend.outputs.backend_status }}
      BACKEND_ACTIVE_ENV: ${{ needs.deploy_backend.outputs.backend_active_env }}
      BACKEND_INACTIVE_ENV: ${{ needs.deploy_backend.outputs.backend_inactive_env }}
      BACKEND_ACTIVE_TG: ${{ needs.deploy_backend.outputs.backend_active_tg }}
      BACKEND_INACTIVE_TG: ${{ needs.deploy_backend.outputs.backend_inactive_tg }}
      BACKEND_INSTANCE_IDS: ${{ needs.deploy_backend.outputs.backend_instance_ids }}
  
      # Frontend outputs
      FRONTEND_CURRENT_IMAGE: ${{ needs.deploy_frontend.outputs.frontend_current_image }}
      FRONTEND_PREVIOUS_IMAGE: ${{ needs.deploy_frontend.outputs.frontend_previous_image }}
      FRONTEND_STATUS: ${{ needs.deploy_frontend.outputs.frontend_status }}
      FRONTEND_ACTIVE_ENV: ${{ needs.deploy_frontend.outputs.frontend_active_env }}
      FRONTEND_INACTIVE_ENV: ${{ needs.deploy_frontend.outputs.frontend_inactive_env }}
      FRONTEND_ACTIVE_TG: ${{ needs.deploy_frontend.outputs.frontend_active_tg }}
      FRONTEND_INACTIVE_TG: ${{ needs.deploy_frontend.outputs.frontend_inactive_tg }}
      FRONTEND_INSTANCE_IDS: ${{ needs.deploy_frontend.outputs.frontend_instance_ids }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Download infra outputs JSON
        run: |
          S3_JSON_PATH="s3://multi-cloud-cost-and-service-status-dashboard/infra/multi-cloud-dashboard-outputs.json"
          aws s3 cp "$S3_JSON_PATH" infra-outputs.json
  
      - name: Print all outputs for debugging
        run: |
          echo "=== Worker Outputs ==="
          echo "Current Image: $WORKER_CURRENT_IMAGE"
          echo "Previous Image: $WORKER_PREVIOUS_IMAGE"
          echo "Status: $WORKER_STATUS"
          echo "Instance IDs: $WORKER_INSTANCE_IDS"
  
          echo "=== Backend Outputs ==="
          echo "Current Image: $BACKEND_CURRENT_IMAGE"
          echo "Previous Image: $BACKEND_PREVIOUS_IMAGE"
          echo "Status: $BACKEND_STATUS"
          echo "Active Env: $BACKEND_ACTIVE_ENV"
          echo "Inactive Env: $BACKEND_INACTIVE_ENV"
          echo "Active TG: $BACKEND_ACTIVE_TG"
          echo "Inactive TG: $BACKEND_INACTIVE_TG"
          echo "Instance IDs: $BACKEND_INSTANCE_IDS"
  
          echo "=== Frontend Outputs ==="
          echo "Current Image: $FRONTEND_CURRENT_IMAGE"
          echo "Previous Image: $FRONTEND_PREVIOUS_IMAGE"
          echo "Status: $FRONTEND_STATUS"
          echo "Active Env: $FRONTEND_ACTIVE_ENV"
          echo "Inactive Env: $FRONTEND_INACTIVE_ENV"
          echo "Active TG: $FRONTEND_ACTIVE_TG"
          echo "Inactive TG: $FRONTEND_INACTIVE_TG"
          echo "Instance IDs: $FRONTEND_INSTANCE_IDS"
  
      - name: Run metadata.py
        run: |
          python3 ./deploy/metadata.py --outputs-json "infra-outputs.json"



